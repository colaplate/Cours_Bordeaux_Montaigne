<div>Moumoune, Méchant, Qui es-ce ?</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.sound.min.js"></script>
<script src="p5.serialport.js"></script>
<script src="https://unpkg.com/ml5@0.4.3/dist/ml5.min.js"></script>
<script type="text/javascript">

  //Arduino
  var serial;
  var portName = 'COM6'
  var  inData=0;
  

  // Classifier Variable
  let classifier;
  // Model URL
  let imageModelURL = './';
  
  let ListSong1 
  let ListSong2 
  let ListSong3 
  // Video
  let video;
  let flippedVideo;
  // To store the classification
  let label = "";

  // Load the model first
  function preload() 
  {
    classifier = ml5.imageClassifier(imageModelURL + 'model.json');
    sound1 = loadSound("01K.m4a")
    sound2 = loadSound("02M.m4a")
    sound3 = loadSound("03PDC.m4a")
  }

  function setup() {
    createCanvas(1120, 720);
    // Create the video
    video = createCapture(VIDEO);
    video.size(1120, 720);
    video.hide();
    sound1.setLoop(false)
    sound2.setLoop(false)
    sound3.setLoop(false)

    serial = new p5.SerialPort(); 
//    serial.on('list', printList);  // set a callback function for the serialport list event
    serial.on('connected', serverConnected); // callback for connecting to the server
    serial.on('open', portOpen);        // callback for the port opening
    serial.on('data', serialEvent);     // callback for when new data arrives
    serial.on('error', serialError);    // callback for errors
    serial.on('close', portClose);      // callback for the port closing
//    serial.list(); 
    serial.open(portName, {baudrate: 9600});

    
    flippedVideo = ml5.flipImage(video)
    // Start classifying
    classifyVideo();
  }

  function draw() {
    background(0);
    // Draw the video
    image(flippedVideo, 0, 0);

    // Draw the label
    fill(255);
    textSize(16);
    textAlign(CENTER);
    text(label, width / 2, height - 4);
  }

  // Get a prediction for the current video frame
  function classifyVideo() {
    flippedVideo = ml5.flipImage(video)
    classifier.classify(flippedVideo, gotResult);
  }

  // When we get a result
  function gotResult(error, results) {
    // If there is an error
    if (error) {
      console.error(error);
      return;
    }
    // The results are in an array ordered by confidence.
    // console.log(results[0]);
    label = results[0].label;
    if (label == "Méchant, Chat de Kylian")
    {
        if (sound1.isPlaying() == false)
        {
          sound2.stop();
          sound3.stop();
          sound1.play();
          serial.write(1);
        }

    }
    else if (label == "Moumoune, Chat de Marion")
    {
       if (sound2.isPlaying() == false)
       {
          sound1.stop();
          sound3.stop();
          sound2.play();
          serial.write(2);
      }
    }
    else if (label == "PAS DE CHAT")
    {
       if (sound3.isPlaying() == false)
       {
          sound2.stop();
          sound1.stop();
          sound3.play();
          serial.write(0);
      }
    }
    // Classifiy again!
    classifyVideo();
  }


// ----------------------------------------------------------------
function serverConnected() 
{
  console.log('connected to server.');
}
 
// ----------------------------------------------------------------
function portOpen() 
{
  console.log('the serial port opened.')
}
 
// ----------------------------------------------------------------
function serialEvent() 
{
}
 
// ----------------------------------------------------------------
function serialError(err) {
  console.log('Something went wrong with the serial port. ' + err);
}
 
// ----------------------------------------------------------------
function portClose() 
{
  console.log('The serial port closed.');
}


</script>
